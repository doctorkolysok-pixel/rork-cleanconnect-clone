# 📊 Архитектура приложения TazaGo

## 🏗️ Структура системы

```
┌─────────────────────────────────────────────────────────────┐
│                      ВАШЕ ПРИЛОЖЕНИЕ                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────┐      HTTP/tRPC      ┌──────────────────┐
│   ФРОНТЕНД      │ ◄──────────────────► │    БЭКЕНД        │
│                 │                      │                  │
│ React Native    │   Запросы (fetch)    │ Hono + tRPC      │
│ + Expo Router   │                      │ + Node.js        │
│                 │   Ответы (JSON)      │                  │
│ bun run start   │ ◄──────────────────► │ bun server/...   │
│                 │                      │                  │
│ Порт: 8081      │                      │ Порт: 3000       │
└─────────────────┘                      └────────┬─────────┘
                                                  │
                                                  │ SQL
                                                  │
                                         ┌────────▼─────────┐
                                         │   БАЗА ДАННЫХ    │
                                         │                  │
                                         │ SQLite (local)   │
                                         │ tazago.db        │
                                         │                  │
                                         │ Drizzle ORM      │
                                         └──────────────────┘
```

## 🔄 Последовательность запуска

```
1️⃣ База данных                  2️⃣ Бэкенд                    3️⃣ Фронтенд
────────────────              ────────────────              ────────────────
┌──────────────┐              ┌──────────────┐              ┌──────────────┐
│  Настройка   │              │              │              │              │
│     БД       │    ──────►   │  Запуск      │    ──────►   │  Запуск      │
│              │              │  сервера     │              │  Expo        │
└──────────────┘              └──────────────┘              └──────────────┘

Команды:                      bun server/     bun run
- drizzle-kit generate        index.ts                       start
- drizzle-kit migrate
- backend/db/seed.ts

Только при первом запуске!    ОБЯЗАТЕЛЬНО!                  После бэкенда
```

## ⚠️ Почему возникает ошибка "Failed to fetch"

```
❌ НЕПРАВИЛЬНО:
┌──────────────┐
│  Фронтенд    │ ──── fetch ───► ❌ Бэкенд не запущен
└──────────────┘                   (ошибка!)


✅ ПРАВИЛЬНО:
┌──────────────┐                ┌──────────────┐
│  Фронтенд    │ ──── fetch ──► │  Бэкенд      │ ──► ✅ Ответ
└──────────────┘                └──────────────┘     {"status":"ok"}
```

## 🔍 Диагностика проблемы

### Шаг 1: Проверьте бэкенд
```bash
curl http://localhost:3000/
```

**Ожидаемый результат:**
```json
{"status":"ok","message":"API is running"}
```

**Если ошибка:**
- `Connection refused` → Бэкенд не запущен
- `Timeout` → Проблема с портом/сетью
- Ничего не происходит → Неправильный URL

### Шаг 2: Проверьте tRPC endpoint
```bash
curl http://localhost:3000/api/trpc
```

**Ожидаемый результат:** Любой ответ (не ошибка 404)

### Шаг 3: Проверьте базу данных
```bash
ls -la tazago.db
```

**Ожидаемый результат:** Файл существует и не пустой

## 📝 Типичные проблемы и решения

| Проблема | Причина | Решение |
|----------|---------|---------|
| `Failed to fetch` | Бэкенд не запущен | `bun server/index.ts` |
| `Port 3000 is in use` | Порт занят | `PORT=3001 bun server/index.ts` |
| `no such table: users` | БД не настроена | Выполните миграции |
| `Connection refused` на телефоне | Нет туннеля | Используйте `--tunnel` флаг |

## 🎯 Контрольный чеклист

Перед началом работы проверьте:

- [ ] База данных создана (`tazago.db` существует)
- [ ] Миграции применены (`bun drizzle-kit migrate`)
- [ ] **Терминал 1:** Бэкенд запущен и работает
- [ ] **Терминал 2:** Фронтенд запущен
- [ ] Бэкенд отвечает на `http://localhost:3000/`
- [ ] Приложение открыто (web или устройство)
- [ ] Авторизация работает без ошибок

## 💻 Рабочая среда разработки

### Идеальная настройка:

```
┌─────────────────────────────────────────────────────┐
│  VSCode / Другой редактор                           │
│  ┌───────────────┐  ┌──────────────────┐            │
│  │ Терминал 1    │  │ Терминал 2       │            │
│  │               │  │                  │            │
│  │ $ bun server/ │  │ $ bun run start  │            │
│  │   index.ts    │  │                  │            │
│  │               │  │                  │            │
│  │ [Бэкенд]      │  │ [Фронтенд]       │            │
│  │ Не закрывать! │  │ QR-код для      │            │
│  │               │  │ телефона         │            │
│  └───────────────┘  └──────────────────┘            │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  Браузер                                            │
│  ┌────────────────────────────────────┐             │
│  │ http://localhost:3000/             │             │
│  │ {"status":"ok","message":"API..."}│             │
│  └────────────────────────────────────┘             │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  Телефон (Expo Go)                                  │
│  Сканируйте QR-код из Терминала 2                  │
└─────────────────────────────────────────────────────┘
```

## 🚀 Быстрый старт для новичков

```bash
# 1. Установите зависимости (если ещё не делали)
bun install

# 2. Настройте базу данных (только первый раз)
bun drizzle-kit generate
bun drizzle-kit migrate
bun backend/db/seed.ts

# 3. Откройте ДВА терминала

# В ТЕРМИНАЛЕ 1:
bun server/index.ts
# Увидите: ✅ Сервер успешно запущен!
# НЕ ЗАКРЫВАЙТЕ ЭТОТ ТЕРМИНАЛ!

# В ТЕРМИНАЛЕ 2:
bun run start
# Увидите QR-код и ссылки
# Откройте на телефоне или в браузере

# 4. Готово! Теперь можете работать с приложением
```

---

📚 **Дополнительно:**
- `ЗАПУСК_ПРИЛОЖЕНИЯ.md` - Подробная инструкция
- `БЫСТРОЕ_РЕШЕНИЕ_ОШИБКИ.md` - Экстренная помощь
- `check-backend.ts` - Скрипт проверки

🎉 **Успешной разработки!**
